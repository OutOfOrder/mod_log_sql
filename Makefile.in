# $Id: Makefile.in,v 1.1 2003/07/22 04:17:53 helios Exp $

###########################################################################
# Don't uncomment this without reading the "Optimizing for a busy database"
# section in the documentation (under "Advanced logging scenarios").

#@DEFS@

#MYSQLDELAYED = -DWANT_DELAYED_MYSQL_INSERT

###########################################################################
# Rarely if ever have to touch below here.

MLMVERS  = 1.18
#APXSGDB  = -Wc,-g
APXSOPTS = -Wc,-O2 -Wc,-Wall
STATOPTS = -fpic -O2 -Wall
CC       = @CC@
INSTALL  = @INSTALL@ -m 664
RM       = @RM@
LYX      = @LYX@
LATEX    = @LATEX@
DVIPS    = @DVIPS@
LINKS    = @LINKS@
L2H      = @L2H@
WEBSERV  = gw0.corp

ifeq (@HAVE_MODSSL@, 1)
   FLAGS     = -DEAPI -I@MYSQLHDRDIR@ $(MYSQLDELAYED) -I@APSRCDIR@/src/modules/ssl -DWANT_SSL_LOGGING
else
   FLAGS     = -DEAPI -I@MYSQLHDRDIR@ $(MYSQLDELAYED)
endif

all:
	@echo "You can choose to make mod_log_sql as a static or dynamic module."
	@echo "Either 'make dso' or 'make static'."
	@echo
	@echo "Please first read the documentation carefully!"

dso: mod_log_sql.so

static: mod_log_sql.o

mod_log_sql.so: mod_log_sql.c Makefile
	@APXSDIR@/apxs -c $(APXSGDB) $(APXSOPTS) $(FLAGS) -L@MYSQLLIBDIR@ @LIBS@ mod_log_sql.c

mod_log_sql.o:	mod_log_sql.c Makefile
	$(CC) $(STATOPTS) $(FLAGS) -I@APHDRDIR@ -c mod_log_sql.c

dsoinstall: dso
	@APXSDIR@/apxs -i mod_log_sql.so

statinstall: static
	$(INSTALL) -d -m 755 @APSRCDIR@/src/modules/sql
	$(INSTALL) mod_log_sql.c @APSRCDIR@/src/modules/sql/mod_log_sql.c
	$(INSTALL) Makefile @APSRCDIR@/src/modules/sql/Makefile
	$(INSTALL) mod_log_sql.o @APSRCDIR@/src/modules/sql/mod_log_sql.o

clean:
	$(RM) -rf *.o *.so
	$(RM) -f Documentation/HTML/*.html Documentation/HTML/*.css Documentation/HTML/*.png
	$(RM) -f Documentation/*.tex
	$(RM) -f Documentation/*.dvi
	$(RM) -f Documentation/*.ps
	$(RM) -f Documentation/*.txt

distclean: clean
	$(RM) -f config.log config.status config.cache config.guess confdefs.h Makefile config.h

distro: documentation
	@scp CHANGELOG $(WEBSERV):@APDSTDIR@/html/mod_log_sql/docs
	@scp Documentation/*.ps $(WEBSERV):@APDSTDIR@/html/mod_log_sql/docs
	@scp Documentation/HTML/*.html $(WEBSERV):@APDSTDIR@/html/mod_log_sql/docs/
	@scp Documentation/HTML/*.png $(WEBSERV):@APDSTDIR@/html/mod_log_sql/docs/
	@cd ..; tar jcf mod_log_sql-$(MLMVERS).tar.bz2 --exclude mod_log_sql/CVS --exclude mod_log_sql/Documentation/CVS --exclude mod_log_sql/Documentation/HTML/CVS --exclude ".directory" mod_log_sql/; scp mod_log_sql-$(MLMVERS).tar.bz2 $(WEBSERV):@APDSTDIR@/html/mod_log_sql/; rm -f mod_log_sql-$(MLMVERS).tar.bz2
	@ssh $(WEBSERV) "ln -sf mod_log_sql-$(MLMVERS).tar.bz2 @APDSTDIR@/html/mod_log_sql/mod_log_sql.tar.bz2"

pre-distro: documentation
	@cd ..; tar jcf mod_log_sql-$(MLMVERS).tar.bz2 --exclude mod_log_sql/CVS --exclude mod_log_sql/Documentation/CVS --exclude mod_log_sql/Documentation/HTML/CVS --exclude ".directory" mod_log_sql/; scp mod_log_sql-$(MLMVERS).tar.bz2 $(WEBSERV):@APDSTDIR@/html/mod_log_sql/; rm -f mod_log_sql-$(MLMVERS).tar.bz2

documentation: Documentation/documentation.lyx
	@echo "Creating LaTeX docs..."
	@$(LYX) --export latex Documentation/documentation.lyx 2>/dev/null
	@echo "Creating cross-references...run 1"
	@cd Documentation ; $(LATEX) documentation.tex >/dev/null 2>&1
	@echo "Creating cross-references...run 2"
	@cd Documentation ; $(LATEX) documentation.tex >/dev/null 2>&1
	@echo "Creating cross-references...run 3"
	@cd Documentation ; $(LATEX) documentation.tex >/dev/null 2>&1
	@echo "Creating PostScript docs..."
	@$(DVIPS) Documentation/documentation.dvi -o Documentation/documentation.ps 2>/dev/null
	@echo "Creating HTML docs..."
	@$(L2H) -local_icons -show_section_numbers -split 4 -navigation -noindex_in_navigation -contents_in_navigation -dir Documentation/HTML Documentation/documentation.tex >/dev/null 2>&1
	@echo "Creating plain text docs..."
	@$(L2H) -show_section_numbers -split 0 -dir Documentation/ Documentation/documentation.tex >/dev/null 2>&1
	@$(LINKS) -dump -nolist -width=120 -dump Documentation/documentation.html > Documentation/documentation.txt 2>/dev/null
	@echo "Cleaning up..."
	@$(RM) -f Documentation/*.html Documentation/WARNINGS Documentation/*.pl Documentation/*.aux Documentation/*.css Documentation/*.toc Documentation/*.log Documentation/*.old Documentation/*.png Documentation/images.tex
	@$(RM) -f Documentation/HTML/WARNINGS Documentation/HTML/*.pl Documentation/HTML/*.log Documentation/HTML/*.aux Documentation/HTML/*.tex Documentation/HTML/*.old Documentation/HTML/index.html
